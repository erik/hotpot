<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Heatmap Viewer</title>

    <script src="https://unpkg.com/maplibre-gl@4.3.2/dist/maplibre-gl.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.3.2/dist/maplibre-gl.css" />
    <link rel="stylesheet" href="/static/style.css" />

    <script src="/static/main.js"></script>

    <script>
      // globalThis.UPLOADS_ENABLED = {};
      // globalThis.RENDER_ENABLED = {};
      // globalThis.ACTIVITY_PROPERTIES = {};
      // $INJECT$
    </script>
</head>

<body>
    <div id="map"></div>
    <div id="map-overlay">
        <details>
            <summary>Settings</summary>

            <form class="settings" autocomplete="off">
                <fieldset>
                    <legend>Filters</legend>

                    <div class="form-row even">
                        <div class="date-input">
                            <label for="after">Start Date</label>
                            <input key="after" type="date" name="after" id="after" />
                        </div>
                        <div class="date-input">
                            <label for="before">End Date</label>
                            <input key="before" type="date" name="before" id="before" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="filter-label">
                            <label for="filter">Property Filter</label>
                            <span class="filter-link" id="property-modal-link">Properties</span>
                            <span class="filter-link" id="filter-help-modal-link">Help</span>
                        </div>
                        <textarea x-debounce key="filter" name="filter"
                            placeholder='elevation > 1000 && distance > 100'></textarea>
                    </div>

                    <div class="activity-count-row">
                        Matched activities
                        <span id="activity-count">• • •</span>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Heatmap</legend>

                    <div class="form-row simple">
                        <label for="color">Theme</label>
                        <select key="color" name="color">
                            <option value="orange" selected>Orange</option>
                            <option value="pinkish">Pinkish</option>
                            <option value="blue-red">Blue/Red</option>
                            <option value="red">Red</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>

                    <div class="form-row simple" id="gradient-input" style="display: none">
                        <label for="gradient">Gradient</label>
                        <input key="gradient" name="gradient" x-debounce placeholder="1:400;10:fff" />
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Map</legend>

                    <div class="form-row simple">
                        <label for="map">Base Map</label>
                        <select key="map" name="map">
                            <option value="dark-matter-nolabels" selected>
                                Dark (no labels)
                            </option>
                            <option value="positron-nolabels">
                                Light (no labels)
                            </option>
                            <option value="dark-matter">Dark</option>
                            <option value="positron">Light</option>
                            <option value="none-black">Solid Black</option>
                            <option value="none-white">Solid White</option>
                        </select>
                    </div>

                    <div class="form-row simple">
                        <label for="size">Tile Size</label>
                        <select key="size" name="size">
                            <option value="256">256px</option>
                            <option value="512" selected>512px</option>
                        </select>
                    </div>
                    <div class="form-row simple">
                        <label>Tile URL</label>
                        <div id="tile-url" class="value" title="Click to copy">• • •</div>
                    </div>
                </fieldset>
            </form>

            <div id="warnings-container"></div>
        </details>
    </div>

    <script>
        const mapStyleBlack = {
            version: 8,
            sources: {},
            layers: [
                {
                    id: "background",
                    type: "background",
                    paint: { "background-color": "black" },
                },
            ],
        };

        const mapStyleWhite = {
            version: 8,
            sources: {},
            layers: [
                {
                    id: "background",
                    type: "background",
                    paint: { "background-color": "white" },
                },
            ],
        };

        const haveMapView = window.location.hash != "";
        const map = new maplibregl.Map({
            container: "map",
            style: "https://basemaps.cartocdn.com/gl/dark-matter-nolabels-gl-style/style.json",
            center: [0, 0],
            hash: true,
        });

        const nodes = {
            gradient: document.getElementById("gradient-input"),
            properties: document.getElementById("property-modal-link"),
            filterHelp: document.getElementById("filter-help-modal-link"),
            warnings: document.getElementById("warnings-container"),
            activityCount: document.getElementById("activity-count"),
            tileUrl: document.getElementById("tile-url"),
        };

        const urlParams = new URLSearchParams(window.location.search);

        const options = livewire({
            color: null,
            before: null,
            after: null,
            size: "512",
            map: "dark-matter-nolabels",
            filter: null,
            gradient: null,

            $color: ({ color }) => (color === "custom" ? null : color),
            $gradient: ({ color, gradient }) =>
                color === "custom" ? gradient : null,

            $styleUrl: ({ map }) => {
                switch (map) {
                    case "none-black":
                        return mapStyleBlack;
                    case "none-white":
                        return mapStyleWhite;
                    default:
                        return `https://basemaps.cartocdn.com/gl/${map}-gl-style/style.json`;
                }
            },
            $queryString: ({ before, after, filter, $gradient, $color }) =>
                encodeQueryString({
                    before,
                    after,
                    filter,
                    gradient: $gradient,
                    color: $color,
                }),
            $tileUrl: ({ $queryString }) =>
                "/tile/{z}/{x}/{y}{ratio}?" + $queryString,
        })
            .watch(["color"], ({ color }) => {
                nodes.gradient.style.display =
                    color === "custom" ? "grid" : "none";
            })
            .watch(["$styleUrl", "$tileUrl", "size"], ({ $styleUrl }) => {
                map.setStyle($styleUrl);
                map.once("styledata", () => updateMapTileSource());
            })
            .watch(["$queryString"], async ({ $queryString }) => {
                const { div } = createElement;

                async function getActivityCount(qs) {
                    const res = await fetch(`/api/activity-count?${$queryString}`);
                    if (!res.ok) {
                        const err = await res.text();
                        throw new Error(err);
                    }
                    return res.json();
                }

                try {
                    const { count, bounds } = await getActivityCount($queryString);

                    if (count != null) nodes.activityCount.innerText = count;
                    if (bounds != null) zoomControl.setBounds(bounds);

                    nodes.warnings.replaceChildren();
                } catch (err) {
                    nodes.warnings.replaceChildren(div({}, err.toString()))
                }
            })
            .watch(["$tileUrl"], ({ $tileUrl }) => {
                nodes.tileUrl.innerText = `${$tileUrl}`;
            })
            // Sync options to URL
            .watch((options) => {
                // TODO: ignore size, map?
                for (const [key, val] of Object.entries(options)) {
                    if (key.startsWith('$')) {
                        // Skip computed keys
                        continue;
                    } else if (!!val) {
                        urlParams.set(key, val);
                    } else {
                        urlParams.delete(key);
                    }
                }

                const qs = urlParams.toString();
                history.replaceState(null, "",
                    window.location.pathname + (qs ? `?${qs}` : "") + window.location.hash);
            });

        nodes.tileUrl.addEventListener("click", async () => {
            const url = window.location.origin + nodes.tileUrl.innerText;
            if (navigator.share) {
                await navigator.share({ url });
            } else {
                await navigator.clipboard.writeText(url);
            }

            const original = nodes.tileUrl.innerText;
            nodes.tileUrl.innerText = "Copied!";
            setTimeout(() => (nodes.tileUrl.innerText = original), 1500);
        });

        document.querySelectorAll("#map-overlay [key]").forEach((el) => {
            const key = el.getAttribute("key");

            // Load initial values from URL
            const value = urlParams.get(key);
            if (value != null) {
                el.value = value;
                options[key] = value;
            }

            // Wire up form to reactive data stuff
            const handler = (ev) => (options[key] = el.value);
            el.addEventListener(
                "input",
                el.hasAttribute("x-debounce") ? debounce(handler) : handler,
            );
        });

        function updateMapTileSource() {
            if (typeof map.getSource("hotpot") !== "undefined") {
                map.removeLayer("hotpot");
                map.removeSource("hotpot");
            }

            map.addSource("hotpot", {
                type: "raster",
                tiles: [options.$tileUrl],
                tileSize: +options.size,
                minzoom: 0,
                maxzoom: 16,
            }).addLayer({
                id: "hotpot",
                type: "raster",
                source: "hotpot",
            });
        }

        map.on("load", () => updateMapTileSource());
        map.addControl(new maplibregl.NavigationControl());

        const zoomControl = new ZoomToBoundsButton({
            // Don't zoom to activity bounds if we already have a location in
            // URL
            zoomOnInit: !haveMapView
        });
        map.addControl(zoomControl, "top-right");

        globalThis.UPLOADS_ENABLED &&
            map.addControl(new UploadButton(), "top-right");

        globalThis.RENDER_ENABLED &&
            map.addControl(new ExportButton(options), "top-right");

        nodes.properties.addEventListener("click", () =>
            createPropertyModal(globalThis.ACTIVITY_PROPERTIES),
        );
        nodes.filterHelp.addEventListener("click", () =>
            createFilterHelpModal(),
        );
    </script>
</body>

</html>