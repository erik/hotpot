<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Heatmap Viewer</title>

    <script src="https://unpkg.com/maplibre-gl@4.3.2/dist/maplibre-gl.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.3.2/dist/maplibre-gl.css" />
    <link rel="stylesheet" href="/static/style.css" />

    <script src="/static/main.js"></script>

    <script>
      // globalThis.UPLOADS_ENABLED = {};
      // globalThis.RENDER_ENABLED = {};
      // globalThis.ACTIVITY_PROPERTIES = {};
      // $INJECT$
    </script>
</head>

<body>
    <div id="map"></div>
    <div id="map-overlay">
        <details>
            <summary>Settings</summary>

            <form class="settings" autocomplete="off">
                <fieldset>
                    <legend>Filters</legend>

                    <div class="form-row even">
                        <div class="date-input">
                            <label for="after">Start Date</label>
                            <input key="after" type="date" name="after" id="after" />
                        </div>
                        <div class="date-input">
                            <label for="before">End Date</label>
                            <input key="before" type="date" name="before" id="before" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="filter-label">
                            <label for="filter">Property Filter</label>
                            <span class="filter-link" id="property-modal-link">Properties</span>
                            <span class="filter-link" id="filter-help-modal-link">Help</span>
                        </div>
                        <textarea x-debounce key="filter" name="filter"
                            placeholder='e.g. elevation_gain > 1000'></textarea>
                    </div>

                    <div class="activity-count-row">
                        Matched activities
                        <span id="activity-count">• • •</span>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Heatmap</legend>

                    <div class="form-row simple">
                        <label for="color">Theme</label>
                        <select key="color" name="color">
                            <option value="orange" selected>Orange</option>
                            <option value="pinkish">Pinkish</option>
                            <option value="blue-red">Blue/Red</option>
                            <option value="red">Red</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>

                    <div class="form-row simple" id="gradient-input" style="display: none">
                        <label for="gradient">Gradient</label>
                        <input key="gradient" name="gradient" x-debounce placeholder="1:400;10:fff" />
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Map</legend>

                    <div class="form-row simple">
                        <label for="map">Base Map</label>
                        <select key="map" name="map">
                            <option value="dark-matter-nolabels" selected>
                                Dark (no labels)
                            </option>
                            <option value="positron-nolabels">
                                Light (no labels)
                            </option>
                            <option value="dark-matter">Dark</option>
                            <option value="positron">Light</option>
                            <option value="none-black">Solid Black</option>
                            <option value="none-white">Solid White</option>
                            <option value="raster">Custom Raster</option>
                        </select>
                    </div>

                    <div class="form-row simple" id="raster-url-input" style="display: none">
                        <label for="rasterUrl">Raster URL</label>
                        <input key="rasterUrl" name="rasterUrl" x-debounce placeholder="https://tile.example.com/{z}/{x}/{y}.png" />
                    </div>

                    <div class="form-row simple">
                        <label for="size">Tile Size</label>
                        <select key="size" name="size">
                            <option value="256">256px</option>
                            <option value="512" selected>512px</option>
                        </select>
                    </div>
                    <div class="form-row simple">
                        <label>Tile URL</label>
                        <div id="tile-url" class="value" title="Click to copy">• • •</div>
                    </div>
                </fieldset>
            </form>

            <div id="warnings-container"></div>
        </details>
    </div>

    <script>
        const mapStyleBlack = {
            version: 8,
            sources: {},
            layers: [
                {
                    id: "background",
                    type: "background",
                    paint: { "background-color": "black" },
                },
            ],
        };

        const mapStyleWhite = {
            version: 8,
            sources: {},
            layers: [
                {
                    id: "background",
                    type: "background",
                    paint: { "background-color": "white" },
                },
            ],
        };

        const map = new maplibregl.Map({
            container: "map",
            style: "https://basemaps.cartocdn.com/gl/dark-matter-nolabels-gl-style/style.json",
            center: [0, 0],
            hash: true,
        });

        const nodes = {
            gradient: document.getElementById("gradient-input"),
            rasterUrl: document.getElementById("raster-url-input"),
            properties: document.getElementById("property-modal-link"),
            filterHelp: document.getElementById("filter-help-modal-link"),
            warnings: document.getElementById("warnings-container"),
            activityCount: document.getElementById("activity-count"),
            tileUrl: document.getElementById("tile-url"),
        };

        const options = livewire({
            color: null,
            before: null,
            after: null,
            size: "512",
            map: "dark-matter-nolabels",
            filter: null,
            gradient: null,
            rasterUrl: null,

            $color: ({ color }) => (color === "custom" ? null : color),
            $gradient: ({ color, gradient }) =>
                color === "custom" ? gradient : null,

            $rasterUrl: ({ map, rasterUrl }) =>
                map === "raster" && rasterUrl
                    ? rasterUrl.replace("{r}", "2x").replace("{ext}", "png")
                    : null,

            $styleUrl: ({ map, $rasterUrl }) => {
                switch (map) {
                    case "none-black":
                        return mapStyleBlack;
                    case "none-white":
                        return mapStyleWhite;
                    case "raster":
                        return {
                            version: 8,
                            sources: {
                                "raster": {
                                    type: "raster",
                                    tiles: [
                                        $rasterUrl || "https://a.tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey={apiKey}",
                                    ],
                                    tileSize: 256,
                                },
                            },
                            layers: [
                                {
                                    id: "raster",
                                    type: "raster",
                                    source: "raster",
                                    minzoom: 0,
                                    maxzoom: 22,
                                },
                            ],
                        };
                    default:
                        return `https://basemaps.cartocdn.com/gl/${map}-gl-style/style.json`;
                }
            },
            $queryString: ({ before, after, filter, $gradient, $color }) =>
                encodeQueryString({
                    before,
                    after,
                    filter,
                    gradient: $gradient,
                    color: $color,
                }),
            $tileUrl: ({ $queryString }) =>
                "/tile/{z}/{x}/{y}{ratio}?" + $queryString,
        })
            .watch(["color"], ({ color }) => {
                nodes.gradient.style.display =
                    color === "custom" ? "grid" : "none";
            })
            .watch(["map"], ({ map }) => {
                nodes.rasterUrl.style.display =
                    map === "raster" ? "grid" : "none";
            })
            .watch(["$styleUrl", "$tileUrl", "size"], ({ $styleUrl }) => {
                map.setStyle($styleUrl);
                map.once("styledata", () => updateMapTileSource());
            })
            .watch(["$queryString"], async ({ $queryString }) => {
                const { div } = createElement;
                const { count, warnings } = await fetch(
                    `/api/activity-count?${$queryString}`,
                )
                    .then(async (res) => [res.status, await res.text()])
                    .catch((err) => [500, err.toString()])
                    .then(([status, text]) =>
                        status === 200
                            ? { count: text, warnings: null }
                            : { count: null, warnings: text },
                    );

                if (count != null) nodes.activityCount.innerText = count;

                warnings != null
                    ? nodes.warnings.replaceChildren(div({}, warnings))
                    : nodes.warnings.replaceChildren();
            })
            .watch(["$tileUrl"], ({ $tileUrl }) => {
                nodes.tileUrl.innerText = `${$tileUrl}`;
            });

        nodes.tileUrl.addEventListener("click", async () => {
            const url = window.location.origin + nodes.tileUrl.innerText;
            if (navigator.share) {
                await navigator.share({ url });
            } else {
                await navigator.clipboard.writeText(url);
            }

            const original = nodes.tileUrl.innerText;
            nodes.tileUrl.innerText = "Copied!";
            setTimeout(() => (nodes.tileUrl.innerText = original), 1500);
        });

        // Wire up form to reactive data stuff
        document.querySelectorAll("#map-overlay [key]").forEach((el) => {
            const key = el.getAttribute("key");
            const handler = (ev) => (options[key] = el.value);
            el.addEventListener(
                "input",
                el.hasAttribute("x-debounce") ? debounce(handler) : handler,
            );
        });

        function updateMapTileSource() {
            if (typeof map.getSource("hotpot") !== "undefined") {
                map.removeLayer("hotpot");
                map.removeSource("hotpot");
            }

            map.addSource("hotpot", {
                type: "raster",
                tiles: [options.$tileUrl],
                tileSize: +options.size,
                minzoom: 0,
                maxzoom: 16,
            }).addLayer({
                id: "hotpot",
                type: "raster",
                source: "hotpot",
            });
        }

        map.on("load", () => updateMapTileSource());
        map.addControl(new maplibregl.NavigationControl());

        globalThis.UPLOADS_ENABLED &&
            map.addControl(new UploadButton(), "top-right");

        globalThis.RENDER_ENABLED &&
            map.addControl(new ExportButton(options), "top-right");

        nodes.properties.addEventListener("click", () =>
            createPropertyModal(globalThis.ACTIVITY_PROPERTIES),
        );
        nodes.filterHelp.addEventListener("click", () =>
            createFilterHelpModal(),
        );
    </script>
</body>

</html>